<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å£ç¬›â†’éµç›¤ãƒŠãƒ“ï¼ˆè©¦ä½œï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; font-size: 16px; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .big { font-size: 28px; font-weight: 700; }
    .muted { color: #666; }
    .kbd { user-select: none; margin-top: 10px; }
    .keys { position: relative; height: 140px; width: min(980px, 100%); border: 1px solid #ccc; border-radius: 10px; overflow: hidden; background: #fafafa; }
    .white { position: absolute; bottom: 0; height: 140px; border: 1px solid #bbb; background: white; border-radius: 0 0 6px 6px; }
    .black { position: absolute; bottom: 60px; height: 80px; background: #222; border-radius: 0 0 6px 6px; }
    .white.active { background: #dff1ff; }
    .black.active { background: #2b7fff; }
    .label { position: absolute; bottom: 6px; width: 100%; text-align: center; font-size: 12px; color: #333; }
    .black .label { color: #eee; bottom: 4px; font-size: 11px; }
    input[type="range"] { width: 260px; }
    code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>å£ç¬›â†’éµç›¤ãƒŠãƒ“ï¼ˆè©¦ä½œï¼‰ğŸ¹ğŸ«§</h1>

  <div class="row">
    <button id="btnStart">ãƒã‚¤ã‚¯é–‹å§‹</button>
    <button id="btnStop" disabled>åœæ­¢</button>

    <div class="row">
      <div>
        <div class="muted">åŸºæº–A4 (Hz) â€»ãŠã‚‚ã¡ã‚ƒãƒ”ã‚¢ãƒè£œæ­£ç”¨</div>
        <input id="a4" type="range" min="415" max="466" step="1" value="440">
        <span id="a4Val">440</span>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="muted">æ¨å®šçµæœ</div>
    <div class="big" id="noteText">â€”</div>
    <div class="row">
      <div>å‘¨æ³¢æ•°: <code id="freqText">â€”</code> Hz</div>
      <div>ã‚ºãƒ¬: <code id="centText">â€”</code> cent</div>
      <div>ä¿¡é ¼åº¦: <code id="confText">â€”</code></div>
    </div>
    <div class="muted" style="margin-top:8px;">
      ã‚³ãƒ„ï¼šå£ç¬›ã¯ã€Œç´°ãã€ã€Œä¸€å®šã®å¼·ã•ã€ã€Œã‚¹ãƒãƒ›/PCã‹ã‚‰20ã€œ40cmã€ãã‚‰ã„ãŒå®‰å®šã—ã‚„ã™ã„ã€‚
    </div>
  </div>

  <div class="panel kbd">
    <div class="muted">éµç›¤è¡¨ç¤ºï¼ˆC4ã€œB5ã®2ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‰</div>
    <div class="keys" id="keys"></div>
  </div>

<script>
(() => {
  // ====== è¨­å®šï¼ˆã“ã“ã‚’å¤‰ãˆã‚‹ã¨è¡¨ç¤ºéµç›¤ç¯„å›²ã‚’èª¿æ•´ã§ãã‚‹ï¼‰ ======
  // ä¾‹: toy pianoãŒã‚‚ã£ã¨ä½ã„/é«˜ã„ãªã‚‰ startMidi/endMidi ã‚’å¤‰ãˆã‚‹
  const startMidi = 60; // C4
  const endMidi   = 83; // B5ï¼ˆ2ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‰
  const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  // ====== DOM ======
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const a4 = document.getElementById("a4");
  const a4Val = document.getElementById("a4Val");
  const noteText = document.getElementById("noteText");
  const freqText = document.getElementById("freqText");
  const centText = document.getElementById("centText");
  const confText = document.getElementById("confText");
  const keysEl = document.getElementById("keys");

  a4.addEventListener("input", () => a4Val.textContent = a4.value);

  // ====== éµç›¤æç”» ======
  // ç™½éµã®ä¸¦ã³ã ã‘ã§ç­‰åˆ†ã—ã€é»’éµã¯ä¸Šã«é‡ã­ã‚‹ç°¡æ˜“è¡¨ç¤º
  const whitePattern = [0,2,4,5,7,9,11]; // C D E F G A B
  const blackSet = new Set([1,3,6,8,10]); // C#,D#,F#,G#,A#

  const midiToFreq = (m, A4=440) => A4 * Math.pow(2, (m - 69) / 12);
  const midiToName = (m) => {
    const name = noteNames[m % 12];
    const oct = Math.floor(m / 12) - 1;
    return `${name}${oct}`;
  };

  // ç™½éµã®æ•°ã‚’æ•°ãˆã¦æ¨ªå¹…å‰²ã‚Šå½“ã¦
  const whiteMidis = [];
  for (let m = startMidi; m <= endMidi; m++) {
    if (!blackSet.has(m % 12)) whiteMidis.push(m);
  }
  const whiteCount = whiteMidis.length;

  const keyDivByMidi = new Map();

  function renderKeys() {
    keysEl.innerHTML = "";
    const W = keysEl.clientWidth;
    const whiteW = W / whiteCount;

    // ç™½éµ
    whiteMidis.forEach((m, i) => {
      const d = document.createElement("div");
      d.className = "white";
      d.style.left = `${i * whiteW}px`;
      d.style.width = `${whiteW}px`;
      d.dataset.midi = m;

      const lab = document.createElement("div");
      lab.className = "label";
      lab.textContent = midiToName(m);
      d.appendChild(lab);

      keysEl.appendChild(d);
      keyDivByMidi.set(m, d);
    });

    // é»’éµï¼ˆç™½éµã®é–“ã«é…ç½®ã™ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // é»’éµã¯ã€ŒC# ã¯ Cã¨Dã®é–“ã€ãªã©ãªã®ã§ã€ç›´å‰ã®ç™½éµindexã‚’æ¢ã—ã¦ç½®ã
    for (let m = startMidi; m <= endMidi; m++) {
      if (!blackSet.has(m % 12)) continue;

      // ã“ã®é»’éµã®ç›´å‰ã®ç™½éµm-1ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆä¾‹: C#ãªã‚‰Cï¼‰
      let prevWhite = m - 1;
      while (prevWhite >= startMidi && blackSet.has(prevWhite % 12)) prevWhite--;
      const prevIndex = whiteMidis.indexOf(prevWhite);
      if (prevIndex < 0) continue;

      const d = document.createElement("div");
      d.className = "black";
      const bw = whiteW * 0.62;
      d.style.width = `${bw}px`;
      d.style.left = `${(prevIndex + 1) * whiteW - bw/2}px`; // é–“ã®çœŸã‚“ä¸­
      d.dataset.midi = m;

      const lab = document.createElement("div");
      lab.className = "label";
      lab.textContent = midiToName(m);
      d.appendChild(lab);

      keysEl.appendChild(d);
      keyDivByMidi.set(m, d);
    }
  }
  renderKeys();
  window.addEventListener("resize", renderKeys);

  // ====== éŸ³ç¨‹æ¨å®šï¼ˆè‡ªå·±ç›¸é–¢ãƒ™ãƒ¼ã‚¹ï¼‰ ======
  let audioCtx, analyser, mediaStream;
  let rafId = null;

  function autoCorrelate(buf, sampleRate) {
    // ã–ã£ãã‚Šä¿¡é ¼åº¦ã¤ããƒ”ãƒƒãƒæ¨å®š
    // å‚è€ƒï¼šè‡ªå·±ç›¸é–¢ã€‚é™éŸ³æ™‚ã¯nullã€‚
    const SIZE = buf.length;
    let rms = 0;
    for (let i = 0; i < SIZE; i++) {
      const v = buf[i];
      rms += v * v;
    }
    rms = Math.sqrt(rms / SIZE);
    if (rms < 0.012) return {freq: null, conf: 0}; // å°ã•ã™ã

    // DCé™¤å»ï¼ˆå¹³å‡ã‚’å¼•ãï¼‰
    let mean = 0;
    for (let i = 0; i < SIZE; i++) mean += buf[i];
    mean /= SIZE;
    for (let i = 0; i < SIZE; i++) buf[i] -= mean;

    // è‡ªå·±ç›¸é–¢
    const maxLag = Math.floor(sampleRate / 50);   // 50Hzã¾ã§
    const minLag = Math.floor(sampleRate / 2000); // 2000Hzã¾ã§
    let bestLag = -1;
    let bestCorr = 0;

    for (let lag = minLag; lag <= maxLag; lag++) {
      let corr = 0;
      for (let i = 0; i < SIZE - lag; i++) {
        corr += buf[i] * buf[i + lag];
      }
      if (corr > bestCorr) {
        bestCorr = corr;
        bestLag = lag;
      }
    }

    // ä¿¡é ¼åº¦ã£ã½ã„å€¤ï¼ˆrmsã¨ç›¸é–¢ï¼‰
    const conf = Math.min(1, bestCorr / (SIZE * 0.12));

    if (bestLag <= 0 || conf < 0.12) return {freq: null, conf};

    const freq = sampleRate / bestLag;
    return {freq, conf};
  }

  function freqToMidi(f, A4=440) {
    return 69 + 12 * Math.log2(f / A4);
  }
  function centsOffFromMidi(f, midi, A4=440) {
    const ref = midiToFreq(midi, A4);
    return 1200 * Math.log2(f / ref);
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  // å¹³æ»‘åŒ–ï¼ˆãƒ•ãƒ©ã¤ãæŠ‘åˆ¶ï¼‰
  let smoothFreq = null;
  function smooth(newF) {
    const alpha = 0.22; // 0ã«è¿‘ã„ã»ã©ãƒŒãƒ«ãƒŒãƒ«ã€1ã«è¿‘ã„ã»ã©å³å¿œ
    if (smoothFreq == null) smoothFreq = newF;
    smoothFreq = smoothFreq * (1 - alpha) + newF * alpha;
    return smoothFreq;
  }

  function clearActive() {
    for (const d of keyDivByMidi.values()) d.classList.remove("active");
  }

  function setActive(midi) {
    clearActive();
    const d = keyDivByMidi.get(midi);
    if (d) d.classList.add("active");
  }

  function loop() {
    const A4 = Number(a4.value);
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);

    const {freq, conf} = autoCorrelate(buf, audioCtx.sampleRate);

    if (!freq) {
      noteText.textContent = "â€”";
      freqText.textContent = "â€”";
      centText.textContent = "â€”";
      confText.textContent = conf.toFixed(2);
      clearActive();
      rafId = requestAnimationFrame(loop);
      return;
    }

    const f = smooth(freq);
    const midiFloat = freqToMidi(f, A4);
    const midiNearest = Math.round(midiFloat);

    // è¡¨ç¤ºç¯„å›²ã«åã‚ã‚‹ï¼ˆç¯„å›²å¤–ã¯ç«¯ã‚’å…‰ã‚‰ã›ã‚‹ï¼‰
    const midiClamped = clamp(midiNearest, startMidi, endMidi);

    const cents = centsOffFromMidi(f, midiNearest, A4);

    noteText.textContent = midiToName(midiNearest);
    freqText.textContent = f.toFixed(1);
    centText.textContent = (cents >= 0 ? "+" : "") + cents.toFixed(0);
    confText.textContent = conf.toFixed(2);

    setActive(midiClamped);

    rafId = requestAnimationFrame(loop);
  }

  async function start() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const src = audioCtx.createMediaStreamSource(mediaStream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.0;

    src.connect(analyser);

    btnStart.disabled = true;
    btnStop.disabled = false;

    smoothFreq = null;
    rafId = requestAnimationFrame(loop);
  }

  async function stop() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    clearActive();

    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    if (audioCtx) {
      await audioCtx.close();
      audioCtx = null;
    }

    btnStart.disabled = false;
    btnStop.disabled = true;

    noteText.textContent = "â€”";
    freqText.textContent = "â€”";
    centText.textContent = "â€”";
    confText.textContent = "â€”";
  }

  btnStart.addEventListener("click", () => start().catch(err => {
    alert("ãƒã‚¤ã‚¯é–‹å§‹ã«å¤±æ•—: " + err.message);
    console.error(err);
  }));
  btnStop.addEventListener("click", () => stop());

})();
</script>
</body>
</html>
